<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenFit - Seu Diário Nutricional Inteligente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Instrument+Serif:ital@0;1&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #FAFAF9;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F5F5F4;
            --text-primary: #1C1917;
            --text-secondary: #78716C;
            --text-tertiary: #A8A29E;
            --accent: #059669;
            --accent-light: #D1FAE5;
            --accent-dark: #047857;
            --warning: #F59E0B;
            --danger: #EF4444;
            --border: #E7E5E4;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.08);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-full: 9999px;
        }

        /* DARK MODE VARIABLES */
        body.dark-mode {
            --bg-primary: #09090b;
            --bg-secondary: #18181b;
            --bg-tertiary: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-tertiary: #52525b;
            --border: #27272a;
            --shadow-sm: none;
            --shadow-md: none;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .app-container {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            min-height: 100dvh;
            background: var(--bg-primary);
            position: relative;
            padding-bottom: 100px;
            transition: background 0.3s ease;
        }

        /* Header */
        .header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            z-index: 100;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s, background 0.3s ease;
        }

        .header.scrolled {
            border-bottom-color: var(--border);
        }

        .logo {
            font-family: 'Instrument Serif', serif;
            font-size: 24px;
            font-weight: 400;
            letter-spacing: -0.5px;
        }

        .logo span {
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
            transform: scale(1.05);
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-primary);
        }

        /* Date Selector */
        .date-selector {
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .date-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .date-nav button {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .date-nav button:hover {
            background: var(--bg-tertiary);
        }

        .date-nav button svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-secondary);
        }

        .current-date {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .week-days {
            display: flex;
            gap: 6px;
            justify-content: space-between;
        }

        .day-item {
            flex: 1;
            padding: 10px 4px;
            text-align: center;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
            border: 1px solid transparent;
        }

        .day-item:hover {
            border-color: var(--border);
        }

        .day-item.active {
            background: var(--text-primary);
            border-color: var(--text-primary);
        }

        .day-item.active .day-name,
        .day-item.active .day-number {
            color: var(--bg-secondary);
        }

        .day-name {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-number {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .day-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--accent);
            margin: 4px auto 0;
            opacity: 0;
        }

        .day-item.has-data .day-dot {
            opacity: 1;
        }

        .day-item.active .day-dot {
            background: var(--bg-secondary);
        }

        /* Calorie Summary */
        .calorie-summary {
            padding: 0 20px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-md);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 13px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .calorie-value {
            font-family: 'Instrument Serif', serif;
            font-size: 48px;
            font-weight: 400;
            line-height: 1;
            letter-spacing: -2px;
        }

        .calorie-unit {
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .calorie-goal {
            text-align: right;
        }

        .goal-label {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 2px;
        }

        .goal-value {
            font-size: 20px;
            font-weight: 600;
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-dark));
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), #D97706);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), #DC2626);
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .macro-item {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .macro-icon {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-full);
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .macro-icon.protein {
            background: #DBEAFE;
        }

        .macro-icon.carbs {
            background: #FEF3C7;
        }

        .macro-icon.fat {
            background: #FCE7F3;
        }

        /* Dark mode adjustments for icons */
        body.dark-mode .macro-icon.protein {
            background: #1e3a8a;
        }

        body.dark-mode .macro-icon.carbs {
            background: #713f12;
        }

        body.dark-mode .macro-icon.fat {
            background: #831843;
        }

        .macro-icon svg {
            width: 14px;
            height: 14px;
        }

        .macro-value {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .macro-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Sections */
        .section {
            padding: 0 20px;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
        }

        .section-action {
            font-size: 13px;
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }

        /* Meal Cards */
        .meal-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .meal-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .meal-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .meal-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .meal-icon.breakfast {
            background: #FEF3C7;
        }

        .meal-icon.lunch {
            background: #DCFCE7;
        }

        .meal-icon.dinner {
            background: #E0E7FF;
        }

        .meal-icon.snack {
            background: #FCE7F3;
        }

        /* Dark mode icons background */
        body.dark-mode .meal-icon.breakfast {
            background: #78350f;
        }

        body.dark-mode .meal-icon.lunch {
            background: #14532d;
        }

        body.dark-mode .meal-icon.dinner {
            background: #1e3a8a;
        }

        body.dark-mode .meal-icon.snack {
            background: #831843;
        }


        .meal-info {
            flex: 1;
            min-width: 0;
        }

        .meal-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .meal-items {
            font-size: 13px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .meal-calories {
            text-align: right;
            flex-shrink: 0;
        }

        .meal-cal-value {
            font-weight: 600;
            font-size: 15px;
        }

        .meal-cal-label {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Weight Chart */
        .weight-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }

        .weight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .weight-current {
            font-family: 'Instrument Serif', serif;
            font-size: 36px;
            line-height: 1;
        }

        .weight-change {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 500;
        }

        .weight-change.positive {
            background: #FEE2E2;
            color: #DC2626;
        }

        .weight-change.negative {
            background: #D1FAE5;
            color: var(--accent-dark);
        }

        body.dark-mode .weight-change.positive {
            background: #7f1d1d;
            color: #fca5a5;
        }

        body.dark-mode .weight-change.negative {
            background: #064e3b;
            color: #6ee7b7;
        }

        .weight-chart {
            height: 120px;
            position: relative;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        /* TMB Card */
        .tmb-card {
            background: linear-gradient(135deg, var(--text-primary) 0%, #44403C 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            color: var(--bg-primary);
            /* Inverted for contrast in dark mode */
        }

        body.dark-mode .tmb-card {
            background: linear-gradient(135deg, #27272a 0%, #000000 100%);
            color: white;
        }

        .tmb-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .tmb-title {
            font-size: 13px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tmb-edit {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .tmb-edit:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tmb-edit svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        .tmb-value {
            font-family: 'Instrument Serif', serif;
            font-size: 42px;
            margin-bottom: 4px;
        }

        .tmb-label {
            font-size: 13px;
            opacity: 0.6;
        }

        .tmb-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tmb-stat {
            text-align: center;
        }

        .tmb-stat-value {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .tmb-stat-label {
            font-size: 11px;
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 8px 20px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: none;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
        }

        .nav-item.active {
            background: var(--accent-light);
        }

        body.dark-mode .nav-item.active {
            background: rgba(5, 150, 105, 0.2);
        }

        .nav-item svg {
            width: 22px;
            height: 22px;
            stroke: var(--text-secondary);
            transition: stroke 0.2s;
        }

        .nav-item.active svg {
            stroke: var(--accent-dark);
        }

        body.dark-mode .nav-item.active svg {
            stroke: var(--accent);
        }

        .nav-item span {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-item.active span {
            color: var(--accent-dark);
        }

        body.dark-mode .nav-item.active span {
            color: var(--accent);
        }

        /* Camera FAB */
        .fab-camera {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 64px;
            height: 64px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.4);
            transition: all 0.3s;
            z-index: 1001;
        }

        .fab-camera:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 6px 24px rgba(5, 150, 105, 0.5);
        }

        .fab-camera:active {
            transform: translateX(-50%) scale(0.95);
        }

        .fab-camera svg {
            width: 28px;
            height: 28px;
            stroke: white;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: 100%;
            max-width: 430px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            z-index: 2001;
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
            border-top: 1px solid var(--border);
        }

        .modal-overlay.active .modal {
            transform: translateX(-50%) translateY(0);
        }

        .modal-handle {
            width: 36px;
            height: 4px;
            background: var(--border);
            border-radius: var(--radius-full);
            margin: 12px auto;
        }

        .modal-header {
            padding: 8px 20px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--bg-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-secondary);
        }

        .modal-body {
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        /* Camera Modal */
        .camera-preview {
            width: 100%;
            aspect-ratio: 4/3;
            background: var(--text-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
            position: relative;
            margin-bottom: 16px;
        }

        .camera-preview video,
        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .camera-btn {
            width: 72px;
            height: 72px;
            border-radius: var(--radius-full);
            border: 4px solid var(--text-primary);
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .camera-btn:hover {
            background: var(--bg-tertiary);
        }

        .camera-btn.capture {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Analysis Result */
        .analysis-result {
            display: none;
        }

        .analysis-result.active {
            display: block;
        }

        .food-detected {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
        }

        .food-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .food-portion {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .nutrition-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .nutrition-item {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 14px;
            text-align: center;
        }

        .nutrition-value {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .nutrition-value.calories {
            color: var(--accent);
        }

        .nutrition-label {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-md);
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-secondary);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            margin-top: 10px;
        }

        /* Form Inputs */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        body.dark-mode .form-input:focus {
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2378716C' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        /* Screens */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* History Screen */
        .history-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
        }

        .history-thumb {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--bg-tertiary);
        }

        .history-info {
            flex: 1;
        }

        .history-food {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .history-time {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .history-cal {
            font-weight: 600;
            color: var(--accent);
        }

        /* Profile Screen */
        .profile-header {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
        }

        .profile-avatar svg {
            width: 40px;
            height: 40px;
            stroke: white;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .profile-stats {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .profile-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin: 0 20px 16px;
            overflow: hidden;
        }

        .profile-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .profile-item:last-child {
            border-bottom: none;
        }

        .profile-item:hover {
            background: var(--bg-tertiary);
        }

        .profile-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-item-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-item-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-secondary);
        }

        .profile-item-text {
            font-weight: 500;
        }

        .profile-item-value {
            font-size: 14px;
            color: var(--text-tertiary);
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .analyzing-text {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Weight Modal Additions */
        .weight-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .weight-input {
            font-family: 'Instrument Serif', serif;
            font-size: 48px;
            width: 140px;
            text-align: center;
            border: none;
            border-bottom: 2px solid var(--border);
            background: transparent;
            padding: 8px;
            color: var(--text-primary);
        }

        .weight-input:focus {
            outline: none;
            border-bottom-color: var(--accent);
        }

        .weight-unit {
            font-size: 20px;
            color: var(--text-tertiary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: var(--bg-secondary);
            padding: 14px 24px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeInUp 0.4s ease forwards;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="screen active" id="screen-home">
            <header class="header">
                <div class="logo">open<span>fit</span></div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="openModal('settings-modal')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3" />
                            <path
                                d="M12 1v6m0 6v6m11-7h-6m-6 0H1m18.07-4.93l-4.24 4.24m-5.66 5.66l-4.24 4.24m0-14.14l4.24 4.24m5.66 5.66l4.24 4.24" />
                        </svg>
                    </button>
                </div>
            </header>

            <div class="date-selector">
                <div class="date-nav">
                    <button onclick="changeWeek(-1)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                    </button>
                    <span class="current-date" id="current-date">Novembro 2025</span>
                    <button onclick="changeWeek(1)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="m9 18 6-6-6-6" />
                        </svg>
                    </button>
                </div>
                <div class="week-days" id="week-days"></div>
            </div>

            <div class="calorie-summary">
                <div class="summary-card">
                    <div class="summary-header">
                        <div>
                            <div class="summary-title">Consumido Hoje</div>
                            <div class="calorie-value"><span id="calories-consumed">0</span> <span
                                    class="calorie-unit">kcal</span></div>
                        </div>
                        <div class="calorie-goal">
                            <div class="goal-label">Meta</div>
                            <div class="goal-value" id="calorie-goal">2,100</div>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="calorie-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="macro-grid">
                        <div class="macro-item">
                            <div class="macro-icon protein">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#3B82F6">
                                    <circle cx="12" cy="12" r="10" />
                                </svg>
                            </div>
                            <div class="macro-value" id="protein-value">0g</div>
                            <div class="macro-label">Proteína</div>
                        </div>
                        <div class="macro-item">
                            <div class="macro-icon carbs">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#F59E0B">
                                    <circle cx="12" cy="12" r="10" />
                                </svg>
                            </div>
                            <div class="macro-value" id="carbs-value">0g</div>
                            <div class="macro-label">Carbos</div>
                        </div>
                        <div class="macro-item">
                            <div class="macro-icon fat">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#EC4899">
                                    <circle cx="12" cy="12" r="10" />
                                </svg>
                            </div>
                            <div class="macro-value" id="fat-value">0g</div>
                            <div class="macro-label">Gordura</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Refeições</h2>
                    <a href="#" class="section-action" onclick="showScreen('history')">Ver histórico</a>
                </div>
                <div class="meal-list" id="meal-list">
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Peso</h2>
                    <a href="#" class="section-action" onclick="openModal('weight-modal')">+ Registrar</a>
                </div>
                <div class="weight-card">
                    <div class="weight-header">
                        <div class="weight-current"><span id="current-weight">0.0</span> kg</div>
                        <div class="weight-change negative" id="weight-change">
                            -0.0 kg
                        </div>
                    </div>
                    <div class="weight-chart">
                        <canvas id="weight-chart" class="chart-canvas"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Metabolismo Basal</h2>
                </div>
                <div class="tmb-card">
                    <div class="tmb-header">
                        <span class="tmb-title">TMB Estimado</span>
                        <button class="tmb-edit" onclick="openModal('tmb-modal')">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
                            </svg>
                        </button>
                    </div>
                    <div class="tmb-value" id="tmb-value">0</div>
                    <div class="tmb-label">kcal/dia em repouso</div>
                    <div class="tmb-stats">
                        <div class="tmb-stat">
                            <div class="tmb-stat-value" id="user-age">0</div>
                            <div class="tmb-stat-label">Anos</div>
                        </div>
                        <div class="tmb-stat">
                            <div class="tmb-stat-value" id="user-height">0</div>
                            <div class="tmb-stat-label">cm</div>
                        </div>
                        <div class="tmb-stat">
                            <div class="tmb-stat-value" id="activity-level">1.2</div>
                            <div class="tmb-stat-label">Fator</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" id="screen-history">
            <header class="header">
                <button class="icon-btn" onclick="showScreen('home')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="m15 18-6-6 6-6" />
                    </svg>
                </button>
                <span style="font-weight: 600;">Histórico</span>
                <div style="width: 40px;"></div>
            </header>
            <div class="section" style="padding-top: 8px;">
                <div id="history-list">
                </div>
            </div>
        </div>

        <div class="screen" id="screen-profile">
            <header class="header">
                <div style="width: 40px;"></div>
                <span style="font-weight: 600;">Perfil</span>
                <div style="width: 40px;"></div>
            </header>
            <div class="profile-header">
                <div class="profile-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                </div>
                <div class="profile-name" id="profile-name">Usuário</div>
                <div class="profile-stats">Membro do OpenFit</div>
            </div>
            <div class="profile-section">
                <div class="profile-item" onclick="openModal('tmb-modal')">
                    <div class="profile-item-left">
                        <div class="profile-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                        </div>
                        <span class="profile-item-text">Dados Pessoais</span>
                    </div>
                    <span class="profile-item-value">Editar →</span>
                </div>
                <div class="profile-item" onclick="openModal('goal-modal')">
                    <div class="profile-item-left">
                        <div class="profile-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" />
                                <circle cx="12" cy="12" r="6" />
                                <circle cx="12" cy="12" r="2" />
                            </svg>
                        </div>
                        <span class="profile-item-text">Meta de Calorias</span>
                    </div>
                    <span class="profile-item-value" id="profile-goal">2,100 kcal</span>
                </div>
            </div>
            <div class="profile-section">
                <div class="profile-item" onclick="openModal('settings-modal')">
                    <div class="profile-item-left">
                        <div class="profile-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3" />
                                <path
                                    d="M12 1v6m0 6v6m11-7h-6m-6 0H1m18.07-4.93l-4.24 4.24m-5.66 5.66l-4.24 4.24m0-14.14l4.24 4.24m5.66 5.66l4.24 4.24" />
                            </svg>
                        </div>
                        <span class="profile-item-text">Configurações & Tema</span>
                    </div>
                    <span class="profile-item-value">→</span>
                </div>
                <div class="profile-item">
                    <div class="profile-item-left">
                        <div class="profile-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path
                                    d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" />
                                <circle cx="12" cy="13" r="3" />
                            </svg>
                        </div>
                        <span class="profile-item-text">Sobre o OpenFit</span>
                    </div>
                    <span class="profile-item-value">v1.1</span>
                </div>
            </div>
        </div>

        <div class="screen" id="screen-stats">
            <header class="header">
                <div style="width: 40px;"></div>
                <span style="font-weight: 600;">Estatísticas</span>
                <div style="width: 40px;"></div>
            </header>
            <div class="section" style="padding-top: 8px;">
                <div class="summary-card">
                    <div class="summary-title" style="margin-bottom: 16px;">Última Semana</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="nutrition-item">
                            <div class="nutrition-value calories" id="avg-calories">0</div>
                            <div class="nutrition-label">Média Calorias</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="total-meals">0</div>
                            <div class="nutrition-label">Refeições</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="avg-protein">0g</div>
                            <div class="nutrition-label">Média Proteína</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="weight-lost">-0.0 kg</div>
                            <div class="nutrition-label">Peso Perdido</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Consumo Semanal</h2>
                </div>
                <div class="weight-card">
                    <canvas id="calories-chart" class="chart-canvas" style="height: 160px;"></canvas>
                </div>
            </div>
        </div>

        <button class="fab-camera" onclick="openModal('camera-modal')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" />
                <circle cx="12" cy="13" r="3" />
            </svg>
        </button>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="showScreen('home')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
                <span>Início</span>
            </button>
            <button class="nav-item" onclick="showScreen('stats')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" x2="18" y1="20" y2="10" />
                    <line x1="12" x2="12" y1="20" y2="4" />
                    <line x1="6" x2="6" y1="20" y2="14" />
                </svg>
                <span>Stats</span>
            </button>
            <div style="width: 64px;"></div>
            <button class="nav-item" onclick="showScreen('history')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                </svg>
                <span>Histórico</span>
            </button>
            <button class="nav-item" onclick="showScreen('profile')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                </svg>
                <span>Perfil</span>
            </button>
        </nav>
    </div>

    <div class="modal-overlay" id="camera-modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">Analisar Alimento</h3>
                <button class="modal-close" onclick="closeModal('camera-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18" />
                        <path d="m6 6 12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="camera-view">
                    <div class="camera-preview">
                        <video id="camera-feed" autoplay playsinline></video>
                        <img id="captured-image" style="display: none;">
                    </div>
                    <div class="camera-controls">
                        <input type="file" id="file-input" accept="image/*" capture="environment" style="display: none;"
                            onchange="handleFileSelect(event)">
                        <button class="camera-btn capture" onclick="capturePhoto()"></button>
                    </div>
                    <p style="text-align: center; color: var(--text-tertiary); font-size: 13px; margin-top: 12px;">
                        Aponte para o alimento e tire uma foto
                    </p>
                </div>
                <div id="analyzing-view" style="display: none;">
                    <div class="spinner"></div>
                    <p class="analyzing-text">Utilizando API do Claude para identificar prato...</p>
                </div>
                <div id="result-view" class="analysis-result">
                    <div class="food-detected">
                        <div class="food-name" id="detected-food">...</div>
                        <div class="food-portion" id="detected-portion">...</div>
                    </div>
                    <div class="nutrition-breakdown">
                        <div class="nutrition-item">
                            <div class="nutrition-value calories" id="result-calories">0</div>
                            <div class="nutrition-label">Calorias</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="result-protein">0g</div>
                            <div class="nutrition-label">Proteína</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="result-carbs">0g</div>
                            <div class="nutrition-label">Carboidratos</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="result-fat">0g</div>
                            <div class="nutrition-label">Gordura</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Refeição</label>
                        <select class="form-input form-select" id="meal-type">
                            <option value="breakfast">Café da Manhã</option>
                            <option value="lunch" selected>Almoço</option>
                            <option value="dinner">Jantar</option>
                            <option value="snack">Lanche</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addMeal()">Adicionar ao Diário</button>
                    <button class="btn btn-secondary" onclick="retakePhoto()">Tirar Outra Foto</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="weight-modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">Registrar Peso</h3>
                <button class="modal-close" onclick="closeModal('weight-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18" />
                        <path d="m6 6 12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="weight-input-container">
                    <input type="number" class="weight-input" id="new-weight" placeholder="00.0" step="0.1">
                    <span class="weight-unit">kg</span>
                </div>
                <button class="btn btn-primary" onclick="saveWeight()">Salvar Peso</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="tmb-modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">Dados Pessoais</h3>
                <button class="modal-close" onclick="closeModal('tmb-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18" />
                        <path d="m6 6 12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-input" id="input-name" placeholder="Seu nome">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Idade</label>
                        <input type="number" class="form-input" id="input-age" value="28">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sexo</label>
                        <select class="form-input form-select" id="input-sex">
                            <option value="male">Masculino</option>
                            <option value="female">Feminino</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Altura (cm)</label>
                        <input type="number" class="form-input" id="input-height" value="175">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Peso (kg)</label>
                        <input type="number" class="form-input" id="input-weight" value="72.4" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Nível de Atividade</label>
                    <select class="form-input form-select" id="input-activity">
                        <option value="1.2">Sedentário</option>
                        <option value="1.375">Leve (1-3x/semana)</option>
                        <option value="1.55" selected>Moderado (3-5x/semana)</option>
                        <option value="1.725">Intenso (6-7x/semana)</option>
                        <option value="1.9">Muito Intenso</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="saveTMB()">Calcular e Salvar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="goal-modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">Meta de Calorias</h3>
                <button class="modal-close" onclick="closeModal('goal-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18" />
                        <path d="m6 6 12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Meta Diária (kcal)</label>
                    <input type="number" class="form-input" id="input-goal" value="2100">
                </div>
                <p style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 16px;">
                    Baseado no seu TMB de <strong id="tmb-reference">1,780 kcal</strong> e nível de atividade, sua
                    necessidade calórica estimada é <strong id="tdee-reference">2,759 kcal</strong>/dia.
                </p>
                <button class="btn btn-primary" onclick="saveGoal()">Salvar Meta</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">Configurações</h3>
                <button class="modal-close" onclick="closeModal('settings-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18" />
                        <path d="m6 6 12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="profile-item" onclick="toggleDarkMode()">
                    <div class="profile-item-left">
                        <span class="profile-item-text">Modo Escuro</span>
                    </div>
                    <span class="profile-item-value" id="theme-status">Ativar</span>
                </div>
                <br>
                <button class="btn btn-secondary" onclick="resetAllData()" style="color: var(--danger);">Resetar Todos
                    os Dados</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Refeição adicionada!</div>

    <script>
        // --- STATE MANAGEMENT WITH LOCALSTORAGE ---

        let state = {
            currentDate: new Date(),
            selectedDate: new Date(),
            userData: {
                name: '',
                age: 28,
                sex: 'male',
                height: 175,
                weight: 72.4,
                activityLevel: 1.55,
                goal: 2100
            },
            meals: [],
            weights: [],
            dailyData: {},
            theme: 'light' // Default theme
        };


        // Load state from local storage on init
        function loadState() {
            const savedState = localStorage.getItem('openfitState_v2');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                // Restore Dates objects
                state = parsed;
                state.currentDate = new Date(); // always today
                state.selectedDate = new Date();

                // Restore theme
                if (state.theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('theme-status').innerText = 'Desativar';
                }
            } else {
                // First time user? Prompt setup via TMB modal
                setTimeout(() => openModal('tmb-modal'), 500);
            }
        }

        function saveState() {
            localStorage.setItem('openfitState_v2', JSON.stringify(state));
        }

        // Format date to YYYY-MM-DD
        function formatDate(date) {
            return new Date(date).toISOString().split('T')[0];
        }

        // Calculate TMB
        function calculateTMB() {
            const { age, sex, height, weight, activityLevel } = state.userData;
            let tmb;
            if (sex === 'male') {
                tmb = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                tmb = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
            return Math.round(tmb);
        }

        // Calculate TDEE
        function calculateTDEE() {
            return Math.round(calculateTMB() * state.userData.activityLevel);
        }

        // Update UI
        function updateUI() {
            const tmb = calculateTMB();
            const tdee = calculateTDEE();

            document.getElementById('tmb-value').textContent = tmb.toLocaleString();
            document.getElementById('user-age').textContent = state.userData.age;
            document.getElementById('user-height').textContent = state.userData.height;
            document.getElementById('activity-level').textContent = state.userData.activityLevel;
            document.getElementById('calorie-goal').textContent = state.userData.goal.toLocaleString();
            document.getElementById('profile-goal').textContent = state.userData.goal.toLocaleString() + ' kcal';
            document.getElementById('profile-name').textContent = state.userData.name || 'Usuário';
            document.getElementById('input-weight').value = state.userData.weight;

            // Update progress
            const today = formatDate(state.selectedDate);
            const dayData = state.dailyData[today] || { calories: 0, protein: 0, carbs: 0, fat: 0 };
            const progress = Math.min((dayData.calories / state.userData.goal) * 100, 100);

            document.getElementById('calories-consumed').textContent = dayData.calories.toLocaleString();
            document.getElementById('protein-value').textContent = dayData.protein + 'g';
            document.getElementById('carbs-value').textContent = dayData.carbs + 'g';
            document.getElementById('fat-value').textContent = dayData.fat + 'g';

            const progressBar = document.getElementById('calorie-progress');
            progressBar.style.width = progress + '%';
            progressBar.className = 'progress-fill';
            if (progress > 100) progressBar.classList.add('danger');
            else if (progress > 85) progressBar.classList.add('warning');

            // Weight
            if (state.weights.length > 0) {
                const currentWeight = state.weights[state.weights.length - 1].weight;
                document.getElementById('current-weight').textContent = currentWeight.toFixed(1);

                if (state.weights.length > 1) {
                    const prevWeight = state.weights[state.weights.length - 2].weight;
                    const change = currentWeight - prevWeight;
                    const changeEl = document.getElementById('weight-change');
                    changeEl.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="${change > 0 ? 'm18 15-6-6-6 6' : 'm6 9 6 6 6-6'}"/>
                        </svg>
                        ${change > 0 ? '+' : ''}${change.toFixed(1)} kg
                    `;
                    changeEl.className = 'weight-change ' + (change > 0 ? 'positive' : 'negative');
                }
            } else {
                document.getElementById('current-weight').textContent = state.userData.weight;
            }

            // TMB modal references
            document.getElementById('tmb-reference').textContent = tmb.toLocaleString() + ' kcal';
            document.getElementById('tdee-reference').textContent = tdee.toLocaleString() + ' kcal';

            renderMealList(today);
            renderWeekDays();
            renderHistory();
            drawWeightChart();
            drawCaloriesChart();
        }

        function renderMealList(dateStr) {
            const list = document.getElementById('meal-list');
            list.innerHTML = '';

            // Filter meals for specific date
            const daysMeals = state.meals.filter(m => m.date === dateStr);

            if (daysMeals.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-tertiary);">Nenhuma refeição registrada hoje.</div>`;
                return;
            }

            daysMeals.forEach(meal => {
                let icon = '🍽️';
                let iconClass = 'dinner';
                if (meal.time < '10:00') { icon = '🌅'; iconClass = 'breakfast'; }
                else if (meal.time < '15:00') { icon = '🥗'; iconClass = 'lunch'; }
                else if (meal.time < '18:00') { icon = '🍎'; iconClass = 'snack'; }

                const html = `
                    <div class="meal-card">
                        <div class="meal-icon ${iconClass}">${icon}</div>
                        <div class="meal-info">
                            <div class="meal-name">${meal.food}</div>
                            <div class="meal-items">${meal.protein}g P • ${meal.carbs}g C • ${meal.fat}g G</div>
                        </div>
                        <div class="meal-calories">
                            <div class="meal-cal-value">${meal.calories}</div>
                            <div class="meal-cal-label">kcal</div>
                        </div>
                    </div>
                 `;
                list.innerHTML += html;
            });
        }

        // Render week days
        function renderWeekDays() {
            const container = document.getElementById('week-days');
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

            const startOfWeek = new Date(state.selectedDate);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());

            document.getElementById('current-date').textContent = months[state.selectedDate.getMonth()] + ' ' + state.selectedDate.getFullYear();

            let html = '';
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(date.getDate() + i);
                const dateStr = formatDate(date);
                const isActive = formatDate(state.selectedDate) === dateStr;
                const hasData = state.dailyData[dateStr] && state.dailyData[dateStr].calories > 0;

                html += `
                    <div class="day-item ${isActive ? 'active' : ''} ${hasData ? 'has-data' : ''}" onclick="selectDate('${dateStr}')">
                        <div class="day-name">${days[date.getDay()]}</div>
                        <div class="day-number">${date.getDate()}</div>
                        <div class="day-dot"></div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // Select date
        function selectDate(dateStr) {
            // Fix timezone issue by setting time to noon
            const parts = dateStr.split('-');
            state.selectedDate = new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0);
            updateUI();
        }

        // Change week
        function changeWeek(direction) {
            state.selectedDate.setDate(state.selectedDate.getDate() + (direction * 7));
            updateUI();
        }

        // Render history
        function renderHistory() {
            const container = document.getElementById('history-list');
            let html = '';

            if (state.meals.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-tertiary);">Seu histórico está vazio.</div>`;
                return;
            }

            state.meals.forEach(meal => {
                html += `
                    <div class="history-item animate-in">
                        <div class="history-thumb" style="display: flex; align-items: center; justify-content: center; font-size: 24px;">${meal.image || '🍽️'}</div>
                        <div class="history-info">
                            <div class="history-food">${meal.food}</div>
                            <div class="history-time">${meal.date} às ${meal.time}</div>
                        </div>
                        <div class="history-cal">${meal.calories} kcal</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Draw weight chart
        function drawWeightChart() {
            const canvas = document.getElementById('weight-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = 120 * 2;
            ctx.scale(2, 2);

            const width = rect.width;
            const height = 120;
            const padding = { top: 10, right: 10, bottom: 20, left: 35 };

            ctx.clearRect(0, 0, width, height);

            if (state.weights.length < 2) return;

            // Get last 7 weights
            const weightsData = state.weights.slice(-7);
            const weights = weightsData.map(w => w.weight);
            const minW = Math.min(...weights) - 1;
            const maxW = Math.max(...weights) + 1;

            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Grid lines
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border');
            ctx.lineWidth = 1;
            for (let i = 0; i <= 3; i++) {
                const y = padding.top + (chartHeight / 3) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
            }

            // Y axis labels
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-tertiary');
            ctx.font = '11px DM Sans';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 3; i++) {
                const val = maxW - ((maxW - minW) / 3) * i;
                const y = padding.top + (chartHeight / 3) * i;
                ctx.fillText(val.toFixed(1), padding.left - 8, y + 4);
            }

            // Line
            ctx.beginPath();
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            const points = [];
            weightsData.forEach((w, i) => {
                const x = padding.left + (chartWidth / (weightsData.length - 1)) * i;
                const y = padding.top + chartHeight - ((w.weight - minW) / (maxW - minW)) * chartHeight;
                points.push({ x, y });
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Points
            points.forEach((p, i) => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
                ctx.fill();
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-secondary');
                ctx.fill();
            });
        }

        // Draw calories chart
        function drawCaloriesChart() {
            const canvas = document.getElementById('calories-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = 160 * 2;
            ctx.scale(2, 2);

            const width = rect.width;
            const height = 160;
            const padding = { top: 20, right: 10, bottom: 30, left: 10 };

            ctx.clearRect(0, 0, width, height);

            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

            // Get data from dailyData for current week
            const startOfWeek = new Date(state.selectedDate);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());

            const data = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startOfWeek);
                d.setDate(d.getDate() + i);
                const ds = formatDate(d);
                data.push(state.dailyData[ds] ? state.dailyData[ds].calories : 0);
            }

            const goal = state.userData.goal;
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            const barWidth = chartWidth / 7 - 12;
            const maxVal = Math.max(...data, goal) * 1.1 || 2500;

            // Goal line
            const goalY = padding.top + chartHeight - (goal / maxVal) * chartHeight;
            ctx.strokeStyle = '#E7E5E4';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(padding.left, goalY);
            ctx.lineTo(width - padding.right, goalY);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#A8A29E';
            ctx.font = '10px DM Sans';
            ctx.textAlign = 'left';
            ctx.fillText('Meta', padding.left, goalY - 4);

            // Bars
            data.forEach((val, i) => {
                const x = padding.left + (chartWidth / 7) * i + 6;
                const barHeight = (val / maxVal) * chartHeight;
                const y = padding.top + chartHeight - barHeight;

                // Bar
                ctx.beginPath();
                ctx.roundRect(x, y, barWidth, barHeight, 4);
                // Colors based on goal
                if (val > goal) ctx.fillStyle = '#EF4444'; // Red
                else if (val > 0) ctx.fillStyle = '#059669'; // Green
                else ctx.fillStyle = '#E7E5E4'; // Empty

                ctx.fill();

                // Day label
                ctx.fillStyle = '#78716C';
                ctx.font = '11px DM Sans';
                ctx.textAlign = 'center';
                ctx.fillText(days[i], x + barWidth / 2, height - 8);
            });
        }

        // Show screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (screenId === 'stats') {
                setTimeout(drawCaloriesChart, 100);
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            if (modalId === 'camera-modal') {
                startCamera();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'camera-modal') {
                stopCamera();
                resetCameraView();
            }
        }

        // Camera functions
        let stream = null;

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });
                document.getElementById('camera-feed').srcObject = stream;
            } catch (err) {
                console.log('Camera not available, using file input');
                document.getElementById('file-input').click();
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function capturePhoto() {
            const video = document.getElementById('camera-feed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg');
            showCapturedImage(imageData);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => showCapturedImage(e.target.result);
                reader.readAsDataURL(file);
            }
        }

        function showCapturedImage(imageData) {
            document.getElementById('camera-feed').style.display = 'none';
            const img = document.getElementById('captured-image');
            img.src = imageData;
            img.style.display = 'block';

            analyzeFood();
        }

        const SECRET_BLOB = "EARAGREOAFgOGCwlBSgfTSQbADskGQw5B1cJES8KWhQQGiU2KiQGRStZKB0bFR1BGQ4kCgIqGwcWHF4xWwoGIiAlNQNXLVgZMjsUMDZZOkQQXDlaIQ0IHiUlLhw2BSA6KzYDHlUAX0NOASkBABkiRwIVKwVTTD8vKjgIMwoqLzoGXhlbWzYyOlA2JV4tWAEeLCYKLVtZM0AqWwsDERM4GzVaOCg=";

        // Variável global para armazenar a chave (se a senha estiver certa)
        let GLOBAL_API_KEY = null;

        // Função utilitária para descriptografar (XOR simples + Base64)
        function decryptKey(encryptedText, password) {
            try {
                const decoded = atob(encryptedText);
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    result += String.fromCharCode(decoded.charCodeAt(i) ^ password.charCodeAt(i % password.length));
                }
                return result;
            } catch (e) {
                return null;
            }
        }

        // Tenta recuperar a senha salva no cache do navegador
        let sessionPassword = localStorage.getItem('openfit_auth_pass');

        // Se NÃO houver senha salva, pede ao usuário
        if (!sessionPassword) {
            sessionPassword = prompt("🔐 Digite a senha de administrador para iniciar o sistema:");
        }

        // Tenta validar a senha (seja a recuperada do cache ou a digitada agora)
        if (sessionPassword) {
            const attempt = decryptKey(SECRET_BLOB, sessionPassword);

            // Validação: se começar com "sk-", a senha está correta
            if (attempt && attempt.startsWith("sk-")) {
                GLOBAL_API_KEY = attempt;

                // SUCESSO: Salva a senha no cache para não pedir na próxima vez
                localStorage.setItem('openfit_auth_pass', sessionPassword);

                console.log("Sistema de IA liberado.");
            } else {
                // ERRO: Se a senha (digitada ou do cache) estiver errada, limpa o cache e avisa
                localStorage.removeItem('openfit_auth_pass');
                alert("❌ Senha incorreta. O reconhecimento de alimentos por IA não funcionará.");
            }
        } else {
            alert("⚠️ Sem senha. Modo apenas leitura (sem IA).");
        }

        async function analyzeFood() {
            // VERIFICAÇÃO DA CHAVE GLOBAL
            if (!GLOBAL_API_KEY) {
                alert("⚠️ Você não inseriu a senha correta ao iniciar o site.\nA IA está bloqueada. Recarregue a página (F5) e digite 'comicaju'.");
                resetCameraView();
                return;
            }

            document.getElementById('camera-view').style.display = 'none';
            document.getElementById('analyzing-view').style.display = 'block';

            const imageBase64 = document.getElementById('captured-image').src;

            try {
                // CHAMADA REAL PARA A OPENAI
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${GLOBAL_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            {
                                role: "system",
                                content: `Você é um nutricionista experiente. 
                                Identifique o prato na imagem. Se for um prato complexo como Virado à Paulista, Feijoada, etc, considere todos os acompanhamentos visíveis.
                                Estime as calorias totais e macronutrientes para a porção inteira exibida de formaa precisa.
                                Retorne APENAS um JSON puro (sem markdown) com as chaves: 
                                name (string em pt-BR), portion (string), calories (int), protein (int), carbs (int), fat (int).`
                            },
                            {
                                role: "user",
                                content: [
                                    { type: "text", text: "Analise os macros desta refeição." },
                                    { type: "image_url", image_url: { url: imageBase64, detail: "low" } }
                                ]
                            }
                        ],
                        max_tokens: 300,
                        temperature: 0.1,
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro API: ${response.status}`);
                }

                const data = await response.json();
                const foodData = JSON.parse(data.choices[0].message.content);
                console.log("Resposta da IA:", foodData);

                // Atualizar a UI com dados reais
                document.getElementById('detected-food').textContent = foodData.name;
                document.getElementById('detected-portion').textContent = foodData.portion || 'Porção padrão';
                document.getElementById('result-calories').textContent = foodData.calories;
                document.getElementById('result-protein').textContent = foodData.protein + 'g';
                document.getElementById('result-carbs').textContent = foodData.carbs + 'g';
                document.getElementById('result-fat').textContent = foodData.fat + 'g';

                document.getElementById('analyzing-view').style.display = 'none';
                document.getElementById('result-view').classList.add('active');

            } catch (error) {
                console.error("Erro:", error);
                alert("Falha na análise: " + error.message);
                document.getElementById('analyzing-view').style.display = 'none';
                document.getElementById('camera-view').style.display = 'block';
            }
        }

        function retakePhoto() {
            resetCameraView();
            startCamera();
        }

        function resetCameraView() {
            document.getElementById('camera-view').style.display = 'block';
            document.getElementById('analyzing-view').style.display = 'none';
            document.getElementById('result-view').classList.remove('active');
            document.getElementById('camera-feed').style.display = 'block';
            document.getElementById('captured-image').style.display = 'none';
        }

        function addMeal() {
            const today = formatDate(state.selectedDate);
            const calories = parseInt(document.getElementById('result-calories').textContent);
            const protein = parseInt(document.getElementById('result-protein').textContent);
            const carbs = parseInt(document.getElementById('result-carbs').textContent);
            const fat = parseInt(document.getElementById('result-fat').textContent);
            const foodName = document.getElementById('detected-food').textContent;

            if (!state.dailyData[today]) {
                state.dailyData[today] = { calories: 0, protein: 0, carbs: 0, fat: 0, meals: [] };
            }

            state.dailyData[today].calories += calories;
            state.dailyData[today].protein += protein;
            state.dailyData[today].carbs += carbs;
            state.dailyData[today].fat += fat;

            state.meals.unshift({
                date: today,
                time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                food: foodName,
                calories: calories,
                protein: protein,
                carbs: carbs,
                fat: fat,
                image: '📷'
            });

            saveState(); // SAVE TO STORAGE
            closeModal('camera-modal');
            showToast('Refeição adicionada!');
            updateUI();
        }

        // Weight functions
        function saveWeight() {
            const weightVal = document.getElementById('new-weight').value;
            if (!weightVal) return;
            const weight = parseFloat(weightVal);
            const today = formatDate(new Date());

            state.weights.push({ date: today, weight: weight });
            state.userData.weight = weight;

            saveState(); // SAVE TO STORAGE
            closeModal('weight-modal');
            showToast('Peso registrado!');
            updateUI();
        }

        // TMB functions
        function saveTMB() {
            state.userData.name = document.getElementById('input-name').value || 'Usuário';
            state.userData.age = parseInt(document.getElementById('input-age').value);
            state.userData.sex = document.getElementById('input-sex').value;
            state.userData.height = parseInt(document.getElementById('input-height').value);
            state.userData.weight = parseFloat(document.getElementById('input-weight').value);
            state.userData.activityLevel = parseFloat(document.getElementById('input-activity').value);

            saveState(); // SAVE TO STORAGE
            closeModal('tmb-modal');
            showToast('Dados atualizados!');
            updateUI();
        }

        // Goal functions
        function saveGoal() {
            state.userData.goal = parseInt(document.getElementById('input-goal').value);
            saveState(); // SAVE TO STORAGE
            closeModal('goal-modal');
            showToast('Meta atualizada!');
            updateUI();
        }

        // --- NEW SETTINGS & THEME FUNCTIONS ---

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            state.theme = isDark ? 'dark' : 'light';
            document.getElementById('theme-status').innerText = isDark ? 'Desativar' : 'Ativar';
            saveState();
            // Redraw charts to update colors
            drawWeightChart();
            drawCaloriesChart();
        }

        function resetAllData() {
            if (confirm("Tem certeza? Isso apagará todos os seus dados e histórico.")) {
                localStorage.removeItem('openfitState_v2');
                location.reload();
            }
        }

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Modal overlay click to close
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                    if (overlay.id === 'camera-modal') {
                        stopCamera();
                        resetCameraView();
                    }
                }
            });
        });

        // Header scroll effect
        window.addEventListener('scroll', () => {
            const header = document.querySelector('.header');
            if (window.scrollY > 10) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        // Initialize
        loadState(); // Replaced initDemoData with loadState
        updateUI();
    </script>
</body>

</html>
